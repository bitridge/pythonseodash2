{% extends 'core/base.html' %}
{% load static %}

{% block extra_css %}
<style>
    .file-upload-area {
        border: 2px dashed #ddd;
        border-radius: 4px;
        padding: 20px;
        text-align: center;
        margin-bottom: 20px;
        cursor: pointer;
        position: relative;
    }

    .file-upload-area.dragover {
        background-color: #f8f9fa;
        border-color: #0d6efd;
    }

    .file-input {
        opacity: 0;
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        cursor: pointer;
    }

    .file-preview {
        display: inline-block;
        margin: 10px;
        text-align: center;
    }

    .file-preview img {
        max-width: 100px;
        max-height: 100px;
        object-fit: contain;
    }

    .file-preview .file-name {
        font-size: 0.8em;
        word-break: break-all;
        margin-top: 5px;
    }

    .file-preview .remove-file {
        cursor: pointer;
        color: #dc3545;
    }

    #file-list {
        margin-top: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">{{ title }}</h5>
                </div>
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data" id="seoLogForm">
                        {% csrf_token %}
                        
                        {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {{ form.non_field_errors }}
                        </div>
                        {% endif %}

                        <div class="mb-3">
                            <label for="{{ form.project.id_for_label }}" class="form-label">Project</label>
                            {{ form.project }}
                            {% if form.project.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.project.errors }}
                            </div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.date.id_for_label }}" class="form-label">Date</label>
                            {{ form.date }}
                            {% if form.date.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.date.errors }}
                            </div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.work_type.id_for_label }}" class="form-label">Work Type</label>
                            {{ form.work_type }}
                            {% if form.work_type.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.work_type.errors }}
                            </div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.description.id_for_label }}" class="form-label">Description</label>
                            {{ form.description }}
                            {% if form.description.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.description.errors }}
                            </div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Attachments</label>
                            <div class="file-upload-area" id="dropZone">
                                <i class="fas fa-cloud-upload-alt fa-2x mb-2"></i>
                                <p>Drag and drop files here or click to browse</p>
                                {{ form.files }}
                            </div>
                            <small class="form-text text-muted">
                                Supported formats: Images (JPG, PNG, GIF), Documents (PDF, DOC, DOCX), Spreadsheets (XLS, XLSX)<br>
                                Maximum file size: 50MB per file
                            </small>
                            {% if form.files.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.files.errors }}
                            </div>
                            {% endif %}
                            <div id="file-list">
                                {% if seo_log_files %}
                                {% for file in seo_log_files %}
                                <div class="file-preview">
                                    {% if file.is_image %}
                                    <img src="{{ file.file.url }}" alt="{{ file.file_name }}">
                                    {% else %}
                                    <i class="fas fa-file fa-3x"></i>
                                    {% endif %}
                                    <div class="file-name">{{ file.file_name }}</div>
                                </div>
                                {% endfor %}
                                {% endif %}
                            </div>
                        </div>

                        <div class="text-end">
                            <a href="{% url 'seo_logs' %}" class="btn btn-secondary">Cancel</a>
                            <button type="submit" class="btn btn-primary">Save</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.querySelector('.file-input');
    const fileList = document.getElementById('file-list');

    // Prevent default drag behaviors
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
        document.body.addEventListener(eventName, preventDefaults, false);
    });

    // Highlight drop zone when item is dragged over it
    ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, unhighlight, false);
    });

    // Handle dropped files
    dropZone.addEventListener('drop', handleDrop, false);
    
    // Handle files selected through click
    fileInput.addEventListener('change', function(e) {
        handleFiles(e.target.files);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    function highlight(e) {
        dropZone.classList.add('dragover');
    }

    function unhighlight(e) {
        dropZone.classList.remove('dragover');
    }

    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        handleFiles(files);
    }

    function handleFiles(files) {
        fileList.innerHTML = '';
        Array.from(files).forEach(file => {
            if (validateFile(file)) {
                createFilePreview(file);
            }
        });
    }

    function validateFile(file) {
        const maxSize = 50 * 1024 * 1024; // 50MB
        const allowedTypes = [
            'image/jpeg', 'image/png', 'image/gif',
            'application/pdf',
            'application/msword',
            'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
            'application/vnd.ms-excel',
            'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
        ];

        if (file.size > maxSize) {
            alert(`File ${file.name} is too large. Maximum size is 50MB.`);
            return false;
        }

        if (!allowedTypes.includes(file.type)) {
            alert(`File ${file.name} has an unsupported format.`);
            return false;
        }

        return true;
    }

    function createFilePreview(file) {
        const preview = document.createElement('div');
        preview.className = 'file-preview';

        if (file.type.startsWith('image/')) {
            const img = document.createElement('img');
            const reader = new FileReader();
            reader.onload = function(e) {
                img.src = e.target.result;
            }
            reader.readAsDataURL(file);
            preview.appendChild(img);
        } else {
            const icon = document.createElement('i');
            icon.className = getFileIcon(file.type);
            icon.style.fontSize = '48px';
            preview.appendChild(icon);
        }

        const fileName = document.createElement('div');
        fileName.className = 'file-name';
        fileName.textContent = file.name;
        preview.appendChild(fileName);

        fileList.appendChild(preview);
    }

    function getFileIcon(fileType) {
        if (fileType.includes('pdf')) {
            return 'fas fa-file-pdf';
        } else if (fileType.includes('word')) {
            return 'fas fa-file-word';
        } else if (fileType.includes('sheet') || fileType.includes('excel')) {
            return 'fas fa-file-excel';
        }
        return 'fas fa-file';
    }
});
</script>
{% endblock %} 